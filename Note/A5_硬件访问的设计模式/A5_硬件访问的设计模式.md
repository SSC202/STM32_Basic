# STM32 A5_硬件访问的设计模式

参考《C嵌入式编程设计模式》

## 1. 硬件访问的基本概念

嵌入式系统最为直接的特点是必须直接访问硬件，软件可以访问的硬件包含：**基础外设，通信，传感器，运动器（电机）**。

硬件的使用包含**初始化，测试和配置**，通常在启动和执行时或者同时通过嵌入式软件执行这些任务。使用嵌入式软件管理这些硬件，给软件提供命令或者数据或者从软件中收集命令和数据。

### 位域

C语言的位域是一种特殊的结构体成员，允许按位为成员进行定义，指定成员占用的位数，从而节省内存空间。

所谓”位域"是把一个字节中的二进位划分为几个不同的区域，并说明每个区域的位数。每个域有一个域名，允许在程序中按域名进行操作。这样就可以把几个不同的对象用一个字节的二进制位域来表示。

> 典型的实例：
>
> - 用 1 位二进位存放一个开关量时，只有 0 和 1 两种状态。
> - 读取外部文件格式——可以读取非标准的文件格式。例如：9 位的整数。

#### 位域声明

```c
struct 位域结构名 
{
 	type [member_name] : width ;
};
```

| 元素          | 描述                                                         |
| :------------ | :----------------------------------------------------------- |
| `type`        | 只能为 `int`(整型)，`unsigned int`(无符号整型)，`signed int`(有符号整型) 三种类型，决定了如何解释位域的值。 |
| `member_name` | 位域的名称。                                                 |
| `width`       | 位域中位的数量。宽度必须小于或等于指定类型的位宽度。         |

- 相邻位域字段的类型相同，且其位宽之和小于类型的`bit`大小，则后面的字段将紧邻前一个字段存储，直到不能容纳为止。

- 一个位域存储在同一个字节中，如一个字节所剩空间不够存放另一位域时，则会从下一字节起存放该位域。也可以有意使某位域从下一字节开始。

```c
struct bs{
    unsigned int a:4;
    unsigned int  :4;    /* 空域 */
    unsigned int b:4;    /* 从下一字节开始存放 */
    unsigned int c:4
}
```

- 位域的宽度不能超过它所依附的数据类型的长度，成员变量都是有类型的，这个类型限制了成员变量的最大长度，**:** 后面的数字不能超过这个长度。

- 位域可以是无名位域，这时它只用来作填充或调整位置。无名的位域是不能使用的。

#### 位域使用

位域的使用和结构成员的使用相同。

```c
位域变量名.位域名
位域变量名->位域名
```

#### 位域在硬件访问中的缺陷

- 位序具有编译器和处理器依赖性；
- 编译器可能会更改字节填充规则，导致位域映射到不想被映射到的地方；
- 由于嵌入式CPU大多仅支持每次写一个字节或者字，位域有可能不会一次性单独写入，可能会造成线程安全问题。

## 2. 硬件代理模式

硬件代理模式将硬件封装到类或者结构体中。
